---
title: State API
description: Key-value state storage with history tracking
---

# State API

```tsx
const phase = db.state.get<string>("phase");
db.state.set("phase", "review", "tests_passed");
db.state.setMany({ phase: "complete", result: { success: true } });
```

## Contract

- **Sync:** All methods are synchronous
- **Storage:** Values JSON-serialized on write, parsed on read
- **History:** `old_value`/`new_value` stored as JSON strings; timestamps are ISO strings

## Methods

| Method | Signature | Description |
|--------|-----------|-------------|
| `get` | `<T>(key: string) => T \| null` | Get value by key |
| `set` | `<T>(key: string, value: T, trigger?: string) => void` | Set value with optional trigger |
| `setMany` | `(updates: Record<string, unknown>, trigger?: string) => void` | Set multiple values atomically |
| `getAll` | `() => Record<string, unknown>` | Get all state as object |
| `has` | `(key: string) => boolean` | Check if key exists |
| `delete` | `(key: string, trigger?: string) => void` | Delete key |
| `reset` | `() => void` | Clear all state |
| `history` | `(key?: string, limit?: number) => Transition[]` | Get transition history |

## Usage

```tsx
db.state.set("phase", "review");
db.state.set("phase", "review", "tests_passed"); // with trigger

db.state.setMany({ phase: "review", reviewer: "claude" }, "implementation_done");

const phaseHistory = db.state.history("phase", 10);
// [{ id, key, old_value, new_value, trigger, created_at }, ...]
```

## Reactive State

```tsx
import { useSmithers } from "smithers-orchestrator";
import { useQueryValue } from "smithers-orchestrator/db";

function WorkflowBody() {
  const { db, reactiveDb } = useSmithers();
  const { data: phaseJson } = useQueryValue<string>(
    reactiveDb,
    "SELECT value FROM state WHERE key = 'phase'"
  );
  const phase = phaseJson ? JSON.parse(phaseJson) : "start";

  return (
    <If condition={phase === "start"}>
      <Claude onFinished={() => db.state.set("phase", "done")}>
        Complete the task.
      </Claude>
    </If>
  );
}
```

## Types

```tsx
interface Transition {
  id: string;
  execution_id?: string;
  key: string;
  old_value: string | null;
  new_value: string;
  trigger?: string;
  trigger_agent_id?: string;
  created_at: string;
}
```

## Related

- [Database API](/api-reference/database)
- [Database Persistence](/concepts/database-persistence)
