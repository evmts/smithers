---
title: Database
description: SQLite database API for workflow persistence
---

# Database API

The Smithers database provides persistent storage using SQLite (via reactive-sqlite).

## Contract

- **Sync:** All database APIs are synchronous (no Promises).
- **Casing:** Method params are camelCase; return values are snake_case (DB column names).
- **Time:** Timestamps are ISO strings unless a module explicitly maps them to `Date`.
- **Conventions:** See [API Conventions](/api-reference/conventions) for details.

## Creating a Database

```tsx
import { createSmithersDB } from "smithers-orchestrator";

const db = createSmithersDB({
  path: ".smithers/my-workflow.db"
});

// Always close when done
db.close();
```

## Database Structure

| Namespace | Purpose |
|-----------|---------|
| `db.state` | Key-value state storage |
| `db.memories` | Long-term knowledge storage |
| `db.execution` | Execution tracking |
| `db.phases` | Phase tracking |
| `db.steps` | Step tracking |
| `db.agents` | Agent invocation tracking |
| `db.tasks` | Task tracking for Ralph iteration management |
| `db.tools` | Tool call tracking |
| `db.artifacts` | Artifact tracking |
| `db.human` | Human interaction tracking |
| `db.vcs` | VCS operations (commits, reviews) |
| `db.renderFrames` | Render frame snapshots |
| `db.buildState` | Build status coordination |
| `db.vcsQueue` | Serialized VCS operations |
| `db.query` | Raw query access |

## Tasks API

Track task lifecycle within Ralph iterations:

```tsx
// Start a task (returns task ID)
const taskId = db.tasks.start("Claude", "code-review", { scopeId: "phase-1" });

// Complete or fail a task
db.tasks.complete(taskId);
db.tasks.fail(taskId);

// Query task counts for an iteration
const running = db.tasks.getRunningCount(1);
const total = db.tasks.getTotalCount(1);

// List all tasks for current execution
const tasks = db.tasks.list();

// Get current iteration number
const iteration = db.tasks.getCurrentIteration();

// Wrap async work in task lifecycle
const result = await db.tasks.withTask("Claude", "analysis", undefined, async () => {
  // ... do work
  return data;
});
```

### Task Interface

```tsx
interface Task {
  id: string;
  execution_id: string;
  iteration: number;
  scope_id: string | null;
  component_type: string;
  component_name: string | null;
  status: "running" | "completed" | "failed";
  started_at: string;
  completed_at: string | null;
  duration_ms: number | null;
}
```

## Raw Queries

For advanced use cases:

```tsx
const results = db.query<{ count: number }>(
  "SELECT COUNT(*) as count FROM agents WHERE model = ?",
  ["sonnet"]
);
```

## Closing

Always close the database to ensure writes are flushed:

```tsx
db.close();
```

## Related

<CardGroup cols={2}>
  <Card title="State API" icon="database" href="/api-reference/state">
    Key-value storage
  </Card>
  <Card title="Memories API" icon="brain" href="/api-reference/memories">
    Long-term knowledge
  </Card>
  <Card title="Execution API" icon="play" href="/api-reference/execution">
    Execution tracking
  </Card>
  <Card title="VCS API" icon="code-branch" href="/api-reference/vcs">
    Version control
  </Card>
</CardGroup>
