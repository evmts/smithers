---
title: Code Review Agent
description: A complete example of a code review agent with structured output
---

# Code Review Agent

This example demonstrates a practical code review agent that analyzes files for bugs, security issues, and code quality.

## Complete Example

```tsx
import { create } from 'zustand'
import { Claude, Phase, Step, Persona, Constraints, OutputFormat } from '@evmts/smithers'

// Type definitions
interface Issue {
  file: string
  line: number
  severity: 'critical' | 'high' | 'medium' | 'low'
  category: 'bug' | 'security' | 'performance' | 'style'
  message: string
  suggestion?: string
}

interface ReviewResult {
  issues: Issue[]
  summary: string
  overallScore: number
}

// State management
const useReviewStore = create<{
  phase: 'analyze' | 'summarize' | 'complete'
  fileResults: Record<string, Issue[]>
  summary: ReviewResult | null
  addFileResult: (file: string, issues: Issue[]) => void
  setSummary: (summary: ReviewResult) => void
}>((set, get) => ({
  phase: 'analyze',
  fileResults: {},
  summary: null,

  addFileResult: (file, issues) => {
    const fileResults = { ...get().fileResults, [file]: issues }
    const allFiles = Object.keys(fileResults)
    // Check if all files analyzed (simplified - in real code, compare with input)
    set({
      fileResults,
      phase: allFiles.length >= 1 ? 'summarize' : 'analyze',
    })
  },

  setSummary: (summary) => set({ summary, phase: 'complete' }),
}))

// Reusable persona
function CodeReviewer() {
  return (
    <Persona role="Senior Code Reviewer">
      You are an experienced software engineer with 10+ years of experience.
      You've reviewed thousands of pull requests and have deep expertise in
      identifying bugs, security vulnerabilities, and code quality issues.
      You provide constructive, actionable feedback.
    </Persona>
  )
}

// Main agent component
export function CodeReviewAgent({
  files,
  strict = false,
}: {
  files: string[]
  strict?: boolean
}) {
  const { phase, fileResults, addFileResult, setSummary } = useReviewStore()

  // Phase 1: Analyze each file
  if (phase === 'analyze') {
    const pendingFiles = files.filter((f) => !fileResults[f])

    return (
      <>
        {pendingFiles.map((file) => (
          <Subagent key={file} name={`reviewer-${file}`}>
            <Claude
              tools={[filesystem, grep]}
              onFinished={(result: { issues: Issue[] }) =>
                addFileResult(file, result.issues)
              }
            >
              <CodeReviewer />

              <Constraints>
                - Focus on bugs, security issues, and logic errors
                - Ignore formatting and style (that's what linters are for)
                - Be specific about line numbers and provide context
                - Suggest fixes when possible
                {strict && '- Apply strict standards, flag any potential issues'}
              </Constraints>

              <Phase name="review">
                <Step>Read and understand the file: {file}</Step>
                <Step>Identify potential bugs and logic errors</Step>
                <Step>Check for security vulnerabilities</Step>
                <Step>Note performance concerns</Step>
              </Phase>

              <OutputFormat
                schema={{
                  issues: [
                    {
                      file: 'string',
                      line: 'number',
                      severity: 'critical | high | medium | low',
                      category: 'bug | security | performance | style',
                      message: 'string',
                      suggestion: 'string (optional)',
                    },
                  ],
                }}
              >
                Return valid JSON with the issues array. Empty array if no issues.
              </OutputFormat>
            </Claude>
          </Subagent>
        ))}
      </>
    )
  }

  // Phase 2: Generate summary
  if (phase === 'summarize') {
    const allIssues = Object.values(fileResults).flat()

    return (
      <Claude onFinished={setSummary}>
        <CodeReviewer />

        <Phase name="summarize">
          Analyze these code review findings and create a summary:

          {JSON.stringify(allIssues, null, 2)}

          Provide:
          1. An overall assessment
          2. Key issues that need immediate attention
          3. A quality score from 0-100
        </Phase>

        <OutputFormat
          schema={{
            issues: 'Issue[] (same as input)',
            summary: 'string',
            overallScore: 'number (0-100)',
          }}
        >
          Return valid JSON with the complete review.
        </OutputFormat>
      </Claude>
    )
  }

  // Phase 3: Complete - just return the result
  return null
}
```

## Running the Agent

```bash
# Preview the plan
smithers plan code-review.tsx --props '{"files": ["src/auth.ts", "src/db.ts"]}'

# Execute
smithers run code-review.tsx --props '{"files": ["src/auth.ts", "src/db.ts"]}'

# Strict mode
smithers run code-review.tsx --props '{"files": ["src/auth.ts"], "strict": true}'
```

## Example Output

```json
{
  "issues": [
    {
      "file": "src/auth.ts",
      "line": 42,
      "severity": "critical",
      "category": "security",
      "message": "Password comparison using == instead of timing-safe comparison",
      "suggestion": "Use crypto.timingSafeEqual() to prevent timing attacks"
    },
    {
      "file": "src/auth.ts",
      "line": 78,
      "severity": "high",
      "category": "bug",
      "message": "Session token not invalidated on password change",
      "suggestion": "Add session.invalidateAll() after password update"
    },
    {
      "file": "src/db.ts",
      "line": 156,
      "severity": "medium",
      "category": "performance",
      "message": "N+1 query in user loader - fetching permissions in loop",
      "suggestion": "Use eager loading: include: { permissions: true }"
    }
  ],
  "summary": "The codebase has 1 critical security issue that needs immediate attention (timing-safe password comparison). The auth module has a session management bug that could leave users logged in after password changes. Consider addressing the N+1 query for better performance at scale.",
  "overallScore": 65
}
```

## Key Patterns Demonstrated

<CardGroup cols={2}>
  <Card title="Parallel File Analysis" icon="layer-group">
    Each file is analyzed in parallel using Subagent
  </Card>
  <Card title="Multi-Phase Workflow" icon="diagram-project">
    Analyze files, then summarize - phases managed by Zustand
  </Card>
  <Card title="Reusable Personas" icon="user">
    CodeReviewer component encapsulates the expert persona
  </Card>
  <Card title="Structured Output" icon="code">
    JSON schema ensures parseable, typed results
  </Card>
</CardGroup>

## Extending the Example

### Add PR Context

```tsx
function CodeReviewAgent({ files, prTitle, prDescription }) {
  return (
    <Claude tools={[filesystem, grep]}>
      <CodeReviewer />

      <Phase name="context">
        This is a review for PR: "{prTitle}"

        Description: {prDescription}

        Keep the PR context in mind when reviewing.
      </Phase>

      <Phase name="review">
        <Step>Review these files: {files.join(', ')}</Step>
      </Phase>
    </Claude>
  )
}
```

### Add Severity Filtering

```tsx
function CodeReviewAgent({ files, minSeverity = 'low' }) {
  const severityOrder = ['low', 'medium', 'high', 'critical']
  const minIndex = severityOrder.indexOf(minSeverity)

  return (
    <Claude>
      <Constraints>
        Only report issues with severity: {
          severityOrder.slice(minIndex).join(', ')
        }
      </Constraints>
      {/* ... rest of agent */}
    </Claude>
  )
}
```

## Related Examples

<CardGroup cols={2}>
  <Card title="Multi-Agent Team" icon="users" href="/examples/multi-agent">
    Architect + developers pattern
  </Card>
  <Card title="Data Pipeline" icon="database" href="/examples/data-pipeline">
    ETL with error handling
  </Card>
</CardGroup>
