---
title: Multi-Phase Review
description: Implement → Review → Iterate workflow
---

# Multi-Phase Review

```tsx
#!/usr/bin/env smithers

import {
  createSmithersRoot,
  createSmithersDB,
  SmithersProvider,
  Ralph,
  Phase,
  Step,
  Claude,
  Review,
  If,
  useSmithers,
  useQueryValue,
} from "smithers-orchestrator";

async function main() {
  const db = createSmithersDB({ path: ".smithers/review-workflow" });

  let executionId: string;
  const incomplete = db.execution.findIncomplete();
  if (incomplete) {
    executionId = incomplete.id;
    console.log("Resuming:", executionId);
  } else {
    executionId = db.execution.start("Review Workflow", "review-workflow.tsx");
  }

  function ReviewWorkflow() {
    const { db, reactiveDb } = useSmithers();
    const { data: phase } = useQueryValue<string>(
      reactiveDb, "SELECT value FROM state WHERE key = 'phase'"
    );
    const currentPhase = phase ?? "implement";

    return (
      <>
        <If condition={currentPhase === "implement"}>
          <Phase name="Implementation">
            <Step name="implement">
              <Claude
                model="sonnet"
                allowedTools={["Read", "Edit", "Write", "Glob", "Grep"]}
                onFinished={() => db.state.set("phase", "review", "transition_to_review")}
              >
                Implement user authentication: login form, API endpoint, session management.
                Follow existing patterns.
              </Claude>
            </Step>
          </Phase>
        </If>

        <If condition={currentPhase === "review"}>
          <Phase name="Code Review">
            <Step name="review">
              <Review
                target={{ type: "diff", ref: "main" }}
                model="sonnet"
                criteria={[
                  "No security vulnerabilities",
                  "No hardcoded secrets",
                  "Input validation is comprehensive",
                  "Error handling covers edge cases",
                ]}
                onFinished={(review) => {
                  if (review.approved) {
                    console.log("Review passed!");
                    db.state.set("phase", "complete", "approved");
                  } else {
                    console.log("Issues found:", review.issues.length);
                    db.state.set("phase", "implement", "rejected");
                  }
                }}
              />
            </Step>
          </Phase>
        </If>
      </>
    );
  }

  function App() {
    return (
      <SmithersProvider db={db} executionId={executionId} globalTimeout={3600000}>
        <Ralph
          id="review-loop"
          condition={() => {
            const phase = db.state.get<string>("phase");
            return phase !== "complete";
          }}
          maxIterations={10}
        >
          <ReviewWorkflow />
        </Ralph>
      </SmithersProvider>
    );
  }

  try {
    const root = createSmithersRoot();
    await root.mount(App);
    db.execution.complete(executionId, { summary: "Review workflow complete" });
  } catch (err) {
    const error = err instanceof Error ? err : new Error(String(err));
    db.execution.fail(executionId, error.message);
    throw error;
  } finally {
    db.close();
  }
}

main();
```

## Run It

```bash
bun review-workflow.tsx
```

## What's Happening

- **Review**: AI code review against criteria list
- **target**: Reviews diff against main branch
- **Loop**: Failed review returns to implement phase
- **SQLite state**: Survives restarts, no stale closures

## Inspect State

```bash
smithers db state
smithers db transitions
```

## Customization

```tsx
// Stricter criteria
<Review
  criteria={[
    "No security vulnerabilities (OWASP Top 10)",
    "100% test coverage for new code",
    "All public APIs documented",
  ]}
/>

// Add human checkpoint
<If condition={phase === "pre-review"}>
  <Human
    message="Ready for AI review?"
    onApprove={() => db.state.set("phase", "review")}
    onReject={() => db.state.set("phase", "implement")}
  />
</If>
```
