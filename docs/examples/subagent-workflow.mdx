---
title: Subagent Workflow
description: Spawn Smithers subagents for complex subtasks
---

# Subagent Workflow

```tsx
#!/usr/bin/env smithers

import {
  createSmithersRoot,
  createSmithersDB,
  SmithersProvider,
  Phase,
  Step,
  Claude,
  Smithers,
  If,
  useSmithers,
} from "smithers-orchestrator";
import { useQueryValue } from "smithers-orchestrator/db";

async function main() {
  const db = createSmithersDB({ path: ".smithers/feature-dev" });
  const executionId = db.execution.start("Feature Development", "feature-dev.tsx");
  if (db.state.get("phase") === null) {
    db.state.set("phase", "plan", "init_phase");
  }

  function FeatureWorkflow() {
    const { db, reactiveDb } = useSmithers();
    const { data: phase } = useQueryValue<string>(
      reactiveDb, "SELECT value FROM state WHERE key = 'phase'"
    );
    const { data: plan } = useQueryValue<string>(
      reactiveDb, "SELECT value FROM state WHERE key = 'plan'"
    );

    return (
      <>
        <If condition={(phase ?? "plan") === "plan"}>
          <Phase name="Planning">
            <Step name="plan">
              <Claude
                model="opus"
                allowedTools={["Read", "Glob", "Grep"]}
                onFinished={(result) => {
                  db.state.set("plan", result.output, "plan_generated");
                  db.state.set("phase", "implement", "transition_to_implement");
                }}
              >
                Analyze codebase. Create implementation plan for notification system:
                DB schema, REST API, WebSocket updates, React UI.
              </Claude>
            </Step>
          </Phase>
        </If>

        <If condition={phase === "implement"}>
          <Phase name="Implementation">
            <Step name="execute-subagent">
              <Smithers
                plannerModel="opus"
                executionModel="sonnet"
                timeout={3600000}
                keepScript
                context={`Previous analysis:\n${plan ?? ""}`}
                onFinished={(result) => {
                  console.log(`Done in ${result.durationMs}ms`);
                  db.state.set("phase", "test", "transition_to_test");
                }}
                onError={() => db.state.set("phase", "plan", "retry")}
              >
                Implement notification system: migration, CRUD API,
                WebSocket handler, React components, tests.
              </Smithers>
            </Step>
          </Phase>
        </If>

        <If condition={phase === "test"}>
          <Phase name="Verification">
            <Step name="verify">
              <Claude
                model="sonnet"
                allowedTools={["Bash", "Read"]}
                onFinished={(result) => {
                  const next = result.output.includes("All tests pass") ? "done" : "implement";
                  db.state.set("phase", next, `transition_to_${next}`);
                }}
              >
                Run tests: bun test, bun run typecheck. Verify API endpoints exist.
              </Claude>
            </Step>
          </Phase>
        </If>
      </>
    );
  }

  function App() {
    return (
      <SmithersProvider db={db} executionId={executionId} maxIterations={5}>
        <FeatureWorkflow />
      </SmithersProvider>
    );
  }

  try {
    const root = createSmithersRoot();
    await root.mount(App);
    db.execution.complete(executionId, { summary: "Feature development complete" });
  } catch (err) {
    const error = err instanceof Error ? err : new Error(String(err));
    db.execution.fail(executionId, error.message);
    throw error;
  } finally {
    db.close();
  }
}

main();
```

## Run It

```bash
bun feature-dev.tsx
```

## What's Happening

- **Smithers**: Spawns autonomous subagent with its own planner
- **plannerModel**: Opus plans the work
- **executionModel**: Sonnet executes each step
- **keepScript**: Preserves generated script for debugging
- **Phase transitions**: SQLite state drives workflow progression

## Debugging

```tsx
<Smithers
  keepScript
  scriptPath="./.smithers/debug/generated.tsx"
  onError={(err) => console.error("Check script at ./.smithers/debug/generated.tsx")}
>
```

## Nested Subagents

Subagents can spawn their own subagents for complex subtasks:

```tsx
<Smithers>
  Implement the feature. For complex subtasks, spawn additional subagents.
</Smithers>
```
