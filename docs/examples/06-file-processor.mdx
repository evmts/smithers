---
title: "File Processor"
description: "Multi-phase file transformation pipeline with state management"
---

# File Processor

A multi-phase pipeline for reading, transforming, and writing files using Smithers.

## What This Example Shows

- Reading files with the `Glob` and `Read` tools
- Processing file content with Claude
- Writing output with the `<File>` component
- Multi-phase state management with Zustand
- Progress tracking across phases

## The Code

```tsx
import { Claude, executePlan, File } from 'smithers'
import { create } from 'zustand'

interface ProcessorState {
  phase: 'reading' | 'processing' | 'writing' | 'done'
  files: string[]
  processedContent: Record<string, string>
  writtenCount: number
  setPhase: (phase: ProcessorState['phase']) => void
  setFiles: (files: string[]) => void
  setProcessedContent: (content: Record<string, string>) => void
  incrementWritten: () => void
}

const useStore = create<ProcessorState>((set) => ({
  phase: 'reading',
  files: [],
  processedContent: {},
  writtenCount: 0,
  setPhase: (phase) => set({ phase }),
  setFiles: (files) => set({ files }),
  setProcessedContent: (content) => set({ processedContent: content }),
  incrementWritten: () => set((state) => ({
    writtenCount: state.writtenCount + 1
  })),
}))

function FileProcessor({
  pattern,
  outputDir
}: {
  pattern: string
  outputDir: string
}) {
  const {
    phase,
    files,
    processedContent,
    writtenCount,
    setPhase,
    setFiles,
    setProcessedContent,
    incrementWritten
  } = useStore()

  // Reading phase: find files
  if (phase === 'reading') {
    return (
      <Claude
        allowedTools={['Glob', 'Read']}
        onFinished={(result) => {
          const fileList = result.text.match(/\S+\.md/g) || []
          setFiles(fileList)
          setPhase('processing')
        }}
      >
        Find all markdown files matching pattern: {pattern}
        Use Glob to find files, then list them one per line.
      </Claude>
    )
  }

  // Processing phase: transform content
  if (phase === 'processing') {
    return (
      <Claude
        allowedTools={['Read']}
        onFinished={(result) => {
          // Parse Claude's output to extract processed content per file
          // Expected format: markdown header followed by content
          const processed: Record<string, string> = {}
          const resultText = result.text

          // Parse files separated by markdown headers
          files.forEach(file => {
            const filename = file.split('/').pop()
            // Escape regex metacharacters in filename
            const escapedFilename = filename?.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
            // Match heading with optional # markers, followed by content until next file or end
            const filePattern = new RegExp(
              `^#+\\s*${escapedFilename}\\s*\\n([\\s\\S]*?)(?=\\n#+\\s*\\S+\\.md|$)`,
              'm'
            )
            const match = resultText.match(filePattern)
            processed[file] = match ? match[1].trim() : resultText
          })

          setProcessedContent(processed)
          setPhase('writing')
        }}
      >
        Read and process the following markdown files:
        {files.map(f => `\n- ${f}`).join('')}

        For each file:
        1. Read the content
        2. Convert all headers to title case
        3. Add a table of contents at the top
        4. Add word count at the bottom

        Output each file's processed content with the filename as a markdown header (e.g., "## filename.md").
      </Claude>
    )
  }

  // Writing phase: save results
  if (phase === 'writing') {
    return (
      <>
        {Object.entries(processedContent).map(([filename, content]) => {
          const outputPath = `${outputDir}/${filename.split('/').pop()}`
          return (
            <File
              key={filename}
              path={outputPath}
              onWritten={() => {
                console.log(`âœ“ Written: ${outputPath}`)
                incrementWritten()
                if (writtenCount + 1 === files.length) {
                  setPhase('done')
                }
              }}
            >
              {content}
            </File>
          )
        })}
      </>
    )
  }

  return null // Phase: done
}

// CLI execution
const pattern = process.argv[2] || '**/*.md'
const outputDir = process.argv[3] || './processed'

console.log('ðŸ”„ File Processor Starting')
console.log(`  Pattern: ${pattern}`)
console.log(`  Output: ${outputDir}`)

const result = await executePlan(
  <FileProcessor pattern={pattern} outputDir={outputDir} />
)

console.log('âœ… File Processing Complete')
console.log(`  Processed: ${useStore.getState().files.length} files`)
```

## Running

```bash
# Process all markdown files in current directory
bun run examples/06-file-processor/agent.tsx "**/*.md" "./processed"

# Process specific directory
bun run examples/06-file-processor/agent.tsx "docs/**/*.md" "./output"

# Mock mode (no actual file operations)
SMITHERS_MOCK=true bun run examples/06-file-processor/agent.tsx
```

## Key Concepts

### Multi-Phase State Machine

The example uses Zustand to implement a state machine with 4 phases:

1. **Reading**: Find files using Glob
2. **Processing**: Transform file contents with Claude
3. **Writing**: Save results with File components
4. **Done**: All complete

Each phase renders different components based on the current state.

### File Component

The `<File>` component writes content to disk:

```tsx
<File
  path="./output.txt"
  onWritten={() => console.log('Done!')}
>
  File content here
</File>
```

The `onWritten` callback is called after the file is successfully written.

### Progress Tracking

The `writtenCount` state tracks how many files have been written. When it equals the total number of files, we transition to the `done` phase.

### Tool Integration

Shows effective use of built-in tools:
- **Glob** - Find files by pattern
- **Read** - Read file contents
- **File** component - Write results

## Extending This Example

### Add Custom Transformations

Modify the processing phase to apply different transformations:

```tsx
<Claude allowedTools={['Read']}>
  For each file:
  1. Extract code blocks
  2. Add syntax highlighting
  3. Generate documentation
</Claude>
```

### Batch Processing with Rate Limiting

Use ClaudeProvider for processing many files:

```tsx
<ClaudeProvider rateLimit={{ requestsPerMinute: 50 }}>
  {files.map(file => (
    <Claude key={file}>Process {file}</Claude>
  ))}
</ClaudeProvider>
```

### Error Handling

Add error recovery for failed transformations:

```tsx
<Claude
  onError={(error) => {
    console.error(`Failed to process ${file}: ${error.message}`)
    setPhase('retry')
  }}
>
  Process file with validation
</Claude>
```

## Related Examples

- [08-test-generator](/examples/08-test-generator) - Generates test files from source
- [11-rate-limited-batch](/examples/11-rate-limited-batch) - Process many files with rate limiting
- [10-mcp-integration](/examples/10-mcp-integration) - Use MCP filesystem tools
