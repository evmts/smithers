---
title: Renderer Architecture
description: How Smithers transforms JSX into executable AI agent trees
---

# Renderer Architecture

<Warning>
**Advanced.** Internals documentation. Not required for using Smithers.
</Warning>

Custom React renderer that outputs `SmithersNode` trees instead of DOM elements. Trees serialize to XML for execution.

## JSX to Execution Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              YOUR JSX CODE                                      │
│                                                                                 │
│   function MyAgent() {                                                          │
│     const { ralphCount } = useSmithers()                                        │
│     return (                                                                    │
│       <Orchestration>                                                           │
│         <Phase name="build">                                                    │
│           <Claude>                                                              │
│             Fix the bug in auth.ts (iteration {ralphCount})                     │
│           </Claude>                                                             │
│         </Phase>                                                                │
│       </Orchestration>                                                          │
│     )                                                                           │
│   }                                                                             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ Babel/TypeScript transforms JSX
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         JSX RUNTIME (jsx-runtime.ts)                            │
│                                                                                 │
│   // CUSTOM wrapper around React's JSX runtime that exposes React's key:        │
│   import { jsx as reactJsx } from 'react/jsx-runtime'                           │
│                                                                                 │
│   function withSmithersKey(props, key) {                                        │
│     if (key == null) return props                                               │
│     return { ...props, __smithersKey: key }  // Inject key as prop              │
│   }                                                                             │
│                                                                                 │
│   export function jsx(type, props, key) {                                       │
│     return reactJsx(type, withSmithersKey(props, key), key)                     │
│   }                                                                             │
│                                                                                 │
│   // This allows SmithersNode.key to be populated from React's key              │
│   // for plan serialization (key="0" appears in XML output).                    │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ React processes component tree
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         REACT INTERNALS (Fiber Tree)                            │
│                              (React-managed)                                    │
│                                                                                 │
│   React builds an internal "fiber" tree that tracks:                            │
│   - Component instances and their state (useState, useEffect, etc.)             │
│   - Which nodes changed and need updates                                        │
│   - Parent/child/sibling relationships                                          │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  FiberNode (MyAgent)                                                    │   │
│   │  ├─ hooks: [{state: 0, setState: fn}]    ← useState lives here          │   │
│   │  └─ child ─→ FiberNode (Ralph)                                          │   │
│   │              ├─ key: 0                                                  │   │
│   │              └─ child ─→ FiberNode (Phase)                              │   │
│   │                          └─ child ─→ FiberNode (Claude)                 │   │
│   │                                       └─ hooks: [{state:'pending'}]     │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│   When state changes (setCount), React:                                         │
│   1. Marks affected fibers as "needs update"                                    │
│   2. Re-renders components to get new elements                                  │
│   3. Diffs old vs new to find what changed                                      │
│   4. Calls our HOST CONFIG methods to apply changes                             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
          ┌─────────────────────────────┼─────────────────────────────┐
          │                             │                             │
          ▼                             ▼                             ▼
   createInstance()              appendChild()               commitUpdate()
   createTextInstance()          removeChild()               commitTextUpdate()
                                 insertBefore()
          │                             │                             │
          └─────────────────────────────┼─────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      HOST CONFIG (host-config.ts)                               │
│                                                                                 │
│                                                                                 │
│   This is the "bridge" between React and our SmithersNode tree.                 │
│   React calls these methods; we implement them.                                 │
│                                                                                 │
│   const hostConfig = {                                                          │
│     createInstance(type, props) {                                               │
│       // React says "make a <phase>" → we create SmithersNode                   │
│       return rendererMethods.createElement(type)                                │
│     },                                                                          │
│     appendChild(parent, child) {                                                │
│       // React says "put child under parent"                                    │
│       rendererMethods.insertNode(parent, child)                                 │
│     },                                                                          │
│     commitUpdate(instance, payload) {                                           │
│       // React says "props changed on this node"                                │
│       Object.assign(instance.props, payload)                                    │
│     },                                                                          │
│   }                                                                             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ delegates to
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       RENDERER METHODS (methods.ts)                             │
│                                                                                 │
│                                                                                 │
│   Low-level operations on SmithersNode trees.                                   │
│   No React dependency - pure data structure manipulation.                       │
│                                                                                 │
│   rendererMethods = {                                                           │
│     createElement(type) → SmithersNode                                          │
│     createTextNode(text) → SmithersNode                                         │
│     setProperty(node, key, value)                                               │
│     insertNode(parent, child, anchor?)                                          │
│     removeNode(parent, child)                                                   │
│   }                                                                             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ creates/manipulates
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    SMITHERS NODE TREE (types.ts)                                │
│                                                                                 │
│                                                                                 │
│   interface SmithersNode {             ┌───────────────────────────────────┐    │
│     type: string                       │  ROOT                             │    │
│     props: Record<string, unknown>     │  └─ ralph {key:0}                 │    │
│     children: SmithersNode[]           │     └─ phase {name:"build"}       │    │
│     parent: SmithersNode | null        │        └─ claude {status:"..."}   │    │
│     key?: string | number              │           └─ TEXT "Fix the bug"   │    │
│   }                                    └───────────────────────────────────┘    │
│                                                                                 │
│   This is our "virtual DOM" - a plain JS object tree                            │
│   that represents the current state of the agent plan.                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
          ┌─────────────────────────────┴─────────────────────────────┐
          │                                                           │
          ▼                                                           ▼
┌─────────────────────────────────┐                 ┌─────────────────────────────┐
│   SERIALIZER (serialize.ts)     │                 │    COMPONENT EXECUTION      │
│                                 │                 │                             │
│   Converts tree to XML for      │                 │   Claude, Ralph, Phase      │
│   display and approval:         │                 │   components use useMount   │
│                                 │                 │   to execute on render:     │
│   <ralph key="0">               │                 │                             │
│     <phase name="build">        │                 │   useMount(() => {          │
│       <claude status="pending"> │                 │     // Call Claude API      │
│         Fix the bug             │                 │     // Update state         │
│       </claude>                 │                 │     // Trigger re-render    │
│     </phase>                    │                 │   })                        │
│   </ralph>                      │                 │                             │
└─────────────────────────────────┘                 └─────────────────────────────┘
```

## File Structure

```
src/reconciler/
├── index.ts           # Public exports
├── jsx-runtime.ts     # JSX transform (jsx, jsxs, Fragment)
├── types.ts           # SmithersNode, ExecutionState
├── host-config.ts     # React reconciler host config
├── methods.ts         # Low-level node operations
├── root.ts            # createSmithersRoot(), mount()
├── serialize.ts       # Tree → XML serialization
└── hooks.ts           # useMount, useUnmount, useMountedState
```

## Key Concepts

| React Method | Smithers Action |
|--------------|-----------------|
| `createInstance()` | Create SmithersNode |
| `appendChild()` | Insert child node |
| `commitUpdate()` | Update node props |

| React DOM | Smithers |
|-----------|----------|
| `<div>` → DOM Element | `<phase>` → SmithersNode |
| Browser renders pixels | Serializer outputs XML |
| User clicks → events | Claude responses → state changes |

## Why React?

- **Hooks** - State management
- **Reconciliation** - Efficient diffing
- **Components** - Reusable, composable
- **Context** - Dependency injection
- **Familiar** - Leverage existing knowledge

## Usage

```tsx
const root = createSmithersRoot()
await root.mount(() => <MyAgent />)
root.dispose()
```

## Related

<CardGroup cols={2}>
  <Card title="Durable Ralphing" icon="rotate" href="/concepts/ralph-wiggum-loop">
    The execution model
  </Card>
  <Card title="SmithersProvider" icon="cube" href="/components/smithers-provider">
    Root orchestration component
  </Card>
</CardGroup>
