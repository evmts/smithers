<?xml version="1.0" encoding="UTF-8"?>
<prompt>
  <metadata>
    <title>Remove happy-dom and Migrate to XML-based Testing</title>
    <created>2026-01-18</created>
    <category>testing-migration</category>
  </metadata>

  <objective>
    Remove happy-dom and @happy-dom/global-registrator dependencies from this project.
    Migrate tests to use the project's native SmithersNode/XML serialization approach
    instead of DOM-based testing. Smithers uses a custom React reconciler that renders
    to SmithersNode trees, making DOM testing libraries fundamentally incompatible.
  </objective>

  <architecture>
    <component name="Custom JSX Runtime">
      <description>
        tsconfig.json specifies jsxImportSource: "smithers-orchestrator".
        JSX transforms to SmithersNode objects, NOT React DOM elements.
      </description>
      <file>src/reconciler/jsx-runtime.ts</file>
    </component>

    <component name="SmithersNode">
      <description>Core data structure for the component tree</description>
      <file>src/reconciler/types.ts</file>
      <interface><![CDATA[
interface SmithersNode {
  type: string                    // 'claude', 'phase', 'step', 'TEXT', etc.
  props: Record<string, unknown>  // Props passed to component
  children: SmithersNode[]        // Child nodes
  parent: SmithersNode | null     // Parent reference
  key?: string | number           // Reconciliation key
}
      ]]></interface>
    </component>

    <component name="XML Serializer">
      <description>
        Converts SmithersNode trees to readable XML strings.
        Use this for test assertions instead of DOM queries.
      </description>
      <file>src/reconciler/serialize.ts</file>
      <function>serialize(node: SmithersNode): string</function>
    </component>

    <component name="SmithersRoot">
      <description>React reconciler root for mounting components</description>
      <file>src/reconciler/root.ts</file>
      <api>
        <method name="mount">Renders React component to SmithersNode tree</method>
        <method name="getTree">Returns raw SmithersNode tree</method>
        <method name="toXML">Returns XML string representation</method>
        <method name="dispose">Cleanup</method>
      </api>
    </component>
  </architecture>

  <problem>
    <title>Why DOM Testing Fails</title>
    <explanation>
      When JSX is written in this project, it transforms to SmithersNode objects,
      not DOM elements. Libraries like @testing-library/react expect react-dom
      to render actual DOM nodes, but our reconciler never creates DOM.
    </explanation>
    <errors>
      <error>"document is not defined"</error>
      <error>"Invalid hook call" - hooks try to use react-dom's dispatcher</error>
      <error>Type mismatches between SmithersNode and ReactElement</error>
    </errors>
  </problem>

  <tasks>
    <task priority="1">
      <title>Remove Dependencies</title>
      <file>package.json</file>
      <action>Remove dev dependencies: happy-dom, @happy-dom/global-registrator</action>
      <command>bun remove happy-dom @happy-dom/global-registrator</command>
    </task>

    <task priority="2">
      <title>Update Test Preload</title>
      <file>test/preload.ts</file>
      <remove><![CDATA[
import { GlobalRegistrator } from '@happy-dom/global-registrator'
GlobalRegistrator.register()
      ]]></remove>
      <keep><![CDATA[
process.env.SMITHERS_MOCK_MODE = 'true'
process.env.NODE_ENV = 'test'
      ]]></keep>
    </task>

    <task priority="3">
      <title>Migrate Context Tests</title>
      <file>src/reactive-sqlite/hooks/context.test.tsx</file>
      <before><![CDATA[
import { render, screen } from '@testing-library/react'

test('renders children', () => {
  render(
    <DatabaseProvider db={db}>
      <div data-testid="child">Hello</div>
    </DatabaseProvider>
  )
  expect(screen.getByTestId('child')).toBeDefined()
})
      ]]></before>
      <after><![CDATA[
import { jsx } from '../../reconciler/jsx-runtime'
import { serialize } from '../../reconciler/serialize'

test('renders children', () => {
  const tree = jsx(DatabaseProvider, {
    db,
    children: jsx('div', { 'data-testid': 'child', children: 'Hello' })
  })

  const xml = serialize(tree)
  expect(xml).toContain('<div data-testid="child">')
  expect(xml).toContain('Hello')
})
      ]]></after>
    </task>
  </tasks>

  <patterns>
    <pattern name="Direct JSX Function Calls">
      <description>Use jsx() function instead of JSX syntax for explicit control</description>
      <example><![CDATA[
import { jsx, jsxs, Fragment } from './reconciler/jsx-runtime'

test('creates element with props', () => {
  const element = jsx('phase', { name: 'test', count: 42 })

  expect(element.type).toBe('phase')
  expect(element.props.name).toBe('test')
  expect(element.props.count).toBe(42)
})

test('handles nested children', () => {
  const child = jsx('step', { children: 'Hello' })
  const parent = jsx('phase', { name: 'test', children: child })

  expect(parent.children).toHaveLength(1)
  expect(parent.children[0].type).toBe('step')
  expect(parent.children[0].parent).toBe(parent)
})
      ]]></example>
      <reference>src/jsx-runtime.test.ts</reference>
    </pattern>

    <pattern name="XML Serialization Assertions">
      <description>Serialize node tree to XML and assert on string content</description>
      <example><![CDATA[
import { serialize } from './serialize'
import type { SmithersNode } from './types'

test('serializes node to XML', () => {
  const node: SmithersNode = {
    type: 'task',
    props: { name: 'test' },
    children: [],
    parent: null
  }

  expect(serialize(node)).toBe('<task name="test" />')
})

test('handles nested structure', () => {
  const xml = serialize(parentNode)
  expect(xml).toContain('<phase name="setup">')
  expect(xml).toContain('<step>')
})
      ]]></example>
      <reference>src/reconciler/serialize.test.ts</reference>
    </pattern>

    <pattern name="Function Component Testing">
      <description>Function components are invoked during jsx() call</description>
      <example><![CDATA[
test('function component renders correctly', () => {
  function MyComponent({ name }: { name: string }) {
    return jsx('task', { name, children: 'content' })
  }

  const element = jsx(MyComponent, { name: 'test-task' })

  expect(element.type).toBe('task')
  expect(element.props.name).toBe('test-task')
})
      ]]></example>
    </pattern>

    <pattern name="Testing Exports Without Rendering">
      <description>Test module structure and exports without rendering</description>
      <example><![CDATA[
describe('module exports', () => {
  test('exports expected functions', async () => {
    const module = await import('./context')

    expect(typeof module.DatabaseProvider).toBe('function')
    expect(typeof module.useDatabase).toBe('function')
  })

  test('context is a valid React context', () => {
    expect(DatabaseContext.Provider).toBeDefined()
    expect(DatabaseContext.Consumer).toBeDefined()
  })
})
      ]]></example>
    </pattern>
  </patterns>

  <constraints>
    <constraint>No DOM globals needed - tests run in plain Bun</constraint>
    <constraint>Use bun:test for all tests</constraint>
    <constraint>JSX in tests can use JSX syntax OR jsx() function directly</constraint>
    <constraint>Avoid React.createElement - use project's jsx() function</constraint>
    <constraint>No @testing-library - requires react-dom which we don't use</constraint>
  </constraints>

  <verification>
    <step>Run: bun remove happy-dom @happy-dom/global-registrator</step>
    <step>Run: bun test - should pass without DOM errors</step>
    <step>Run: bun run check - typecheck + lint + test</step>
    <step>Verify: grep -r "document\." src/ finds nothing in test files</step>
  </verification>

  <expected-outcome>
    <item>Zero DOM-related dependencies</item>
    <item>All tests pass in plain Bun environment</item>
    <item>Tests use SmithersNode/XML patterns instead of DOM queries</item>
    <item>No skipped tests - convert or remove them</item>
    <item>test/preload.ts contains only env setup, no DOM polyfills</item>
  </expected-outcome>
</prompt>
