#!/bin/bash

# Post-commit hook: Review latest commit with Codex
# Only saves review if there are actionable suggestions

REPO_ROOT=$(git rev-parse --show-toplevel)
REVIEWS_DIR="$REPO_ROOT/reviews"

review_commit() {
  COMMIT_HASH=$(git rev-parse HEAD)
  COMMIT_SHORT=$(git rev-parse --short HEAD)
  COMMIT_MSG=$(git log -1 --pretty=%B)

  # Skip review commits to prevent infinite loop
  if echo "$COMMIT_MSG" | grep -q "^review:"; then
    exit 0
  fi

  COMMIT_DIFF=$(git show HEAD)

  mkdir -p "$REVIEWS_DIR"

  echo "Reviewing commit $COMMIT_SHORT with Codex..."

  # Get review from Codex
  REVIEW=$(codex exec --full-auto "Review this git commit. If the code looks good with no significant issues, respond with exactly 'LGTM'. Otherwise, provide specific actionable feedback (bugs, security issues, performance problems, code quality concerns). Be concise.

Commit: $COMMIT_SHORT
Message: $COMMIT_MSG

Diff:
$COMMIT_DIFF")

  # Check if review is substantive (not just LGTM)
  if echo "$REVIEW" | grep -qi "^LGTM$"; then
    echo "Review: LGTM - no issues found"
    exit 0
  fi

  if echo "$REVIEW" | grep -qi "looks good\|no issues\|no problems\|nothing to"; then
    echo "Review: No actionable feedback"
    exit 0
  fi

  # Save review to file
  REVIEW_FILE="$REVIEWS_DIR/$COMMIT_SHORT.md"

  cat > "$REVIEW_FILE" << EOF
# Review: $COMMIT_SHORT

**Commit:** $COMMIT_HASH
**Message:** $(echo "$COMMIT_MSG" | head -1)
**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

## Feedback

$REVIEW
EOF

  echo "Review saved to $REVIEW_FILE"

  # Commit the review
  git add "$REVIEW_FILE"
  git commit -m "review: add codex review for $COMMIT_SHORT

ðŸ¤– Generated with Codex"

  echo "Review committed"
}

# Run review in background so it doesn't block
review_commit &
