# Code Review for Commit 5dcd928

**Date:** 2026-01-18 01:30:45
**Commit Message:** feat(hooks): add usePrevious and useEffectOnValueChange, refactor components

- Add usePrevious hook from react-use (returns previous render's value)
- Add useEffectOnValueChange for idempotent effects (handles React strict mode)
- Refactor Claude and Smithers components to use useEffectOnValueChange
  instead of manual lastExecutedCount ref pattern

---

Reviewing code changes...

# Code Review for Commit 5dcd928

**Commit Message:** feat(hooks): add usePrevious and useEffectOnValueChange, refactor components

**Summary**
This commit (and the squashed changes provided in the review context) introduces a major refactor to the orchestration engine, moving task tracking from React state (in `Ralph`) to the SQLite database (via `tasks` table). While the infrastructure changes (`SmithersProvider`, `db/tasks.ts`) look robust, **the refactor is incomplete and currently broken.**

The components (`Claude`, `Git/Commit`, etc.) have been updated to use `useSmithers()` but are calling the **deprecated, no-op** `registerTask` function. As a result, no tasks are ever registered in the database, and the orchestration loop in `SmithersProvider` will see 0 running tasks and exit immediately.

### Critical Issues

#### 1. Broken Task Tracking (Orchestration Loop Failure)
- **File:** `src/components/SmithersProvider.tsx` (Line 312)
- **File:** `src/components/Claude.tsx` (Line 64) and all other updated components.
- **Issue:**
    - `SmithersProvider` defines `registerTask` as a warning-only no-op:
      ```typescript
      const registerTask = useMemo(() => () => {
        console.warn('[SmithersProvider] registerTask is deprecated. Use db.tasks.start() instead.')
      }, [])
      ```
    - `SmithersProvider`'s loop relies on querying the DB for running tasks (`SELECT COUNT(*) ... tasks ...`).
    - `Claude.tsx` (and others) calls this no-op `registerTask()`.
    - **Result:** No rows are inserted into the `tasks` table. The `SmithersProvider` loop sees `pendingTasks = 0` and `hasStartedTasks = 0` (or false), and immediately signals completion (`signalOrchestrationComplete()`). The orchestration will finish without doing any work.
- **Suggested Improvement:**
    - Update all agent/hook components (`Claude`, `Smithers`, `Git/*`, `Hooks/*`) to use the new DB API directly.
    - **Example Fix for `Claude.tsx`**:
      ```typescript
      // Get db from context
      const { db, executionId, isStopRequested, ralphCount } = useSmithers()

      useEffectOnValueChange(ralphCount, () => {
        ;(async () => {
          // 1. Start task in DB
          const taskId = db.tasks.start('claude', props.role) // Pass appropriate type/name

          try {
            if (isStopRequested()) {
               // handle stop
               return
            }
            // ... execution logic ...
          } finally {
            // 2. Complete task in DB
            db.tasks.complete(taskId)
          }
        })()
      })
      ```

#### 2. `useEffectOnValueChange` Usage
- **File:** `src/components/Claude.tsx` (and others)
- **Issue:** The components use `useEffectOnValueChange` to trigger execution. As noted in a previous review (Commit `10533bf`), verify that this hook correctly handles component unmounting/remounting (Strict Mode) if it doesn't support cleanup functions or if the dependencies change.
    - If `useEffectOnValueChange` does *not* run cleanup when it re-runs (due to value change), that is fine here since these are "fire-and-forget" async tasks.
    - However, if the component unmounts while the async task is running, there is no cleanup mechanism (e.g. `AbortController`) wired up here to stop the task or mark it as failed/cancelled in the DB.
- **Suggested Improvement:** Ensure `db.tasks.fail(taskId)` is called if the component unmounts while running (if possible), or ensure the async task handles its own lifecycle.

#### 3. JSDoc Copy-Paste Errors
- **File:** `src/components/SmithersProvider.tsx` (Lines 88-120)
- **Issue:** The JSDoc comments contain references like ` @reference/vercel-ai-sdk/packages/codemod/...`. This appears to be accidental copy-paste from an external codebase or a codemod test file.
- **Suggested Improvement:** Remove the confusing ` @reference` tags.

#### 4. Hardcoded Table List in DB Reset
- **File:** `src/db/index.ts` (Line 121)
- **Issue:** The list of tables to drop during reset is hardcoded: `['tasks', 'steps', ...]`.
- **Suggestion:** If `tasks` is foreign-keyed to `executions`, ensure the drop order is correct (child tables first) or that foreign keys are handled. `tasks` references `executions`, so dropping `executions` first might fail if FKs are enforced, or cascade. Dropping `tasks` first is safer. The current order seems okay but maintenance-heavy.

### Summary of Required Changes
You **must** update all components that were using `ralph.registerTask()` to instead use `db.tasks.start(...)` and `db.tasks.complete(...)`. The current code connects components to a no-op, breaking the application's core loop.
