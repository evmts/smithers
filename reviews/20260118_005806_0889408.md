# Code Review for Commit 0889408

**Date:** 2026-01-18 00:58:06
**Commit Message:** feat(reactive-sqlite): add row-level invalidation for fine-grained reactivity

Add extractRowFilter() to parser for extracting row identifiers from
simple WHERE clauses. Implement subscribeWithRowFilter() and
invalidateRows() in ReactiveDatabase for row-level subscription
management. Updates now only trigger subscriptions for affected rows
when possible, falling back to table-level invalidation for complex
queries.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>

---

Review comments for commit 0889408:

### Summary
The row-level invalidation logic is a great addition for performance. However, there is a critical safety issue in how `extractRowFilter` handles `WHERE` clauses with multiple conditions (using `AND`). This can lead to missed updates ("false negatives") where subscriptions fail to trigger for modified rows.

### Issues

**1. Unsafe handling of multiple `AND` conditions (`src/reactive-sqlite/parser.ts`)**
In `extractRowFilter`, the code splits the `WHERE` clause by `AND` and arbitrarily uses the first condition:
```typescript
const conditions = whereClause.split(/\band\b/i)
const firstCondition = conditions[0].trim()
```
This is unsafe for `UPDATE` and `DELETE` operations.
*   **Scenario**: `UPDATE users SET name = 'New' WHERE active = 1 AND id = 5`
*   **Result**: The parser extracts `{ table: 'users', column: 'active', value: 1 }`.
*   **Impact**: The system invalidates listeners subscribed to `active=1`. However, a listener subscribed specifically to `id=5` (e.g., `SELECT * FROM users WHERE id = 5`) will **not** be triggered because the invalidation filter (`active=1`) does not match the subscription filter (`id=5`). The `id=5` listener now holds stale data.

**Suggested Improvement**:
If `conditions.length > 1`, `extractRowFilter` should return `null`. This forces the system to fall back to table-level invalidation (`invalidate(tables)`), which safely triggers *all* listeners for that table.

**2. Brittle parameter counting with `indexOf('where')` (`src/reactive-sqlite/parser.ts`)**
The logic to find parameters uses:
```typescript
const beforeWhere = normalized.substring(0, normalized.toLowerCase().indexOf('where'))
```
This will break if a string literal in the query contains the word "where" (case-insensitive).
*   **Scenario**: `UPDATE posts SET content = 'Where are you?' WHERE id = ?`
*   **Result**: `beforeWhere` truncates at the "Where" inside the string literal. The parameter count will be incorrect, leading to extracting the wrong parameter value for the ID.

**Suggested Improvement**:
Use a more robust regex or parsing method that ignores quoted strings when searching for the `WHERE` keyword, or acknowledge this as a known limitation.
