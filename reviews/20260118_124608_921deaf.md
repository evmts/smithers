# Code Review for Commit 921deaf

**Date:** 2026-01-18 12:46:08
**Commit Message:** chore: remove strictmode-double-execution review (addressed by useEffectOnValueChange)

---

This is a significant and largely positive refactoring that migrates the project from a custom Solid.js-like implementation to a standard React reconciler. The addition of a comprehensive `evals` test suite is a major improvement that dramatically increases test coverage and quality.

However, the commit also includes several new review documents detailing critical (P0) bugs in the current implementation. While the architectural foundation is now much stronger, the control flow logic built on top appears to be broken in several key areas.

### Issues Found

The following critical issues are documented in the new `.md` files added in the `reviews/` directory. They indicate that core functionality is not working as intended.

- **`reviews/step-sequential-deadlock.md` (P0 - Critical):** Sequential `Step` execution is fundamentally broken and results in a deadlock. Non-active steps never start, and the active step never completes its task, causing the entire workflow to hang.

- **`reviews/phase-registry-broken.md` (P0 - Critical):** The `PhaseRegistryProvider` is broken. It resets progress on every mount (making resume impossible) and uses `setState` during render, which is unsafe. More importantly, there is no logic to advance to the next phase upon completion, meaning workflows are stuck on the first phase.

- **`reviews/stop-handling-starts-task.md` (P0 - Critical):** The `stopRequested` mechanism is ineffective. Components register a "running" task in the database *before* checking if a stop has been requested. This prevents the provider from recognizing a "no-op" iteration and causes the loop to continue until `maxIterations` is hit, even after a stop is requested.

- **`reviews/smithers-provider-control-plane.md` (P0 - Critical):** The `SmithersProvider` control plane does not correctly halt iteration when a stop is requested, leading to wasted CPU cycles and iterations.

- **`reviews/orchestration-completion-misaligned.md` (P1 - High):** The `onComplete` callback for `Orchestration` may never fire because the signal for completion does not guarantee the component tree is unmounted, which is where the callback is triggered.

### Suggested Improvements

1.  **Prioritize Fixing P0 Bugs:** The immediate priority must be to address the critical bugs documented in the new review files. The framework's core sequential workflow functionality is currently broken.
2.  **Address Control Flow:** The main theme of the new bugs is a flawed implementation of control flow (phase/step advancement, task completion, stop handling) on top of the new React-based architecture. A thorough review and rewrite of this logic is needed. For example, tying task completion to `useUnmount` is incorrect for components that are meant to persist in the UI for plan visualization. Execution state changes (like a step completing its work) should be used to trigger advancement instead.
3.  **Wire "Plan-Only" Components:** As noted in `reviews/plan-markers-not-wired.md`, several components (`Stop`, `Human`, `Task`, `Persona`, etc.) are rendered to the plan but have no execution logic. These should be implemented to make them functional.
