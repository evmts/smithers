# Code Review for Commit c189459

**Date:** 2026-01-18 00:43:29
**Commit Message:** fix: improve post-commit hook robustness

Address issues from Gemini review:
- Use temp file for prompt to avoid shell escaping issues
- Add mkdir -p to ensure reviews directory exists
- Handle initial commit edge case
- Show stderr from gemini-cli for debugging

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>

---

YOLO mode is enabled. All tool calls will be automatically approved.
Loaded cached credentials.
YOLO mode is enabled. All tool calls will be automatically approved.
LGTM with suggestions.

The robustness improvements (temp files, directory creation) are good. However, there are potential issues with how the process output and diff are handled.

### Issues

**1. Stderr pollution in review content**
Redirecting stderr to the review file (`> "$TEMP_REVIEW" 2>&1`) will mix CLI logs/progress (if any) with the actual response.
- **Risk:** If `gemini-cli` prints "Generating..." or warnings to stderr, the file content becomes `Generating... LGTM`. The strict equality check `"$NORMALIZED" = "lgtm"` will fail, preventing the "clean" exit.
- **Fix:** Keep stderr separate or redirect it to `/dev/tty` if you want it visible for debugging, or a separate log file.

**2. `echo` safety with Diffs**
`echo "$DIFF"` can behave unexpectedly if the diff content contains backslashes or specific escape sequences (depending on the `sh` implementation).
- **Fix:** Use `printf "%s\n" "$DIFF"` for safer string printing.

**3. Initial Commit Diff Syntax**
`git diff --cached 4b8... HEAD` is slightly unusual syntax. `git diff` takes two tree-ish arguments. `--cached` compares the index to a tree.
- While it might work, `git diff 4b825dc642cb6eb9a060e54bf8d69288fbee4904 HEAD` is the standard way to compare the empty tree to HEAD.

**4. CLI Input Method**
Ensure `gemini-cli` supports reading the prompt from **stdin**. The previous version passed the prompt as an argument. If the CLI requires an argument, the pipe `|` will not work as expected.

### Suggested Improvements

```bash
# ... existing setup ...

# Safer diff print
printf "%s\n" "$DIFF" >> "$TEMP_PROMPT"

# Run Gemini CLI
# 1. Verify if gemini-cli supports stdin. If not, use command substitution: $(cat "$TEMP_PROMPT")
# 2. Don't redirect stderr to the review file to avoid breaking the LGTM check
echo "Running Gemini code review..."
cat "$TEMP_PROMPT" | npx --yes https://github.com/google-gemini/gemini-cli --yolo > "$TEMP_REVIEW"

# ... rest of script ...
```
