# Code Review for Commit 6e622e6

**Date:** 2026-01-18 01:19:43
**Commit Message:** feat: stream agent output to log files and track in db

- Update LogWriter to support execution-specific logs and streaming append
- Add log_path column to agents table in database
- Track log path when starting an agent
- Stream Claude agent output to log file in real-time

---

To fix the issues found in the code changes, here is the review:

### Summary
The changes implement execution logging and database tracking effectively. However, there is a critical issue regarding database schema migration for existing databases and a performance consideration regarding synchronous file I/O during streaming.

### Issues

#### 1. Database Schema Migration
- **File:** `src/db/schema.sql`, `src/db/agents.ts`
- **Issue:** Modifying the `CREATE TABLE` statement in `schema.sql` will not update the `agents` table in existing databases. When the application runs `INSERT INTO agents ... (..., log_path, ...)` via `src/db/agents.ts`, it will likely crash with a `no such column: log_path` error for users with an existing database.
- **Suggestion:**
  - Create a migration mechanism to add the column if it doesn't exist (e.g., `ALTER TABLE agents ADD COLUMN log_path TEXT;`).
  - Or, ensure there is a process to reset/migrate the database when the schema changes.

#### 2. Inefficient File I/O
- **File:** `src/monitor/log-writer.ts` (line 55), `src/components/Claude.tsx` (line 148)
- **Issue:** Using `fs.appendFileSync` inside the `onProgress` callback is inefficient. It opens, writes, and closes the file for every single text chunk (token) received from the LLM. This causes unnecessary filesystem overhead and creates synchronous blocking on the main thread, which could degrade performance during rapid streaming.
- **Suggestion:**
  - Use a `fs.WriteStream` in `LogWriter` to keep the file handle open during the stream.
  - Or, verify if buffering is needed.

#### 3. LogWriter Scope (Verification)
- **File:** `src/components/Claude.tsx` (lines 83-84)
- **Issue:** `const logWriter = new LogWriter(...)` and `const logFilename = ...` appear to be instantiated inside the function scope.
  - If `Claude` is a standard React component that re-renders, this will create a new `LogWriter` (and `mkdir` call) and a new `logFilename` (new UUID) on **every render**.
  - If this code is inside a `useEffect` or a specialized execution function that runs once, it is fine.
- **Suggestion:** Ensure this logic is wrapped in a `useEffect` or `useMemo` if it resides directly in the render body.

### Suggested Improvements

**Fixing the DB Insert (Robustness):**
If you cannot run a migration immediately, you might want to wrap the INSERT in a try/catch or check schema versioning.

**Improving Log Performance:**
```typescript
// src/monitor/log-writer.ts
export class LogWriter {
  // ...
  createStream(filename: string): fs.WriteStream {
    const filepath = path.join(this.logDir, filename)
    return fs.createWriteStream(filepath, { flags: 'a' })
  }
}

// src/components/Claude.tsx
// Usage:
const logStream = logWriter.createStream(logFilename);
// ... inside onProgress
logStream.write(chunk);
// ... cleanup
logStream.end();
```
