# Code Review for Commit c33b8b1

**Date:** 2026-01-18 19:51:38
**Commit Message:** Add comprehensive tests for src/utils/

- capture.test.ts: Edge cases for classification, extractors, converters
- vcs/parsers.test.ts: Git/JJ status parsing edge cases (unicode, CRLF, special chars)
- vcs/jj.test.ts: Parser-based tests for JJ operations
- mcp-config.test.ts: Edge cases for MCP config parsing and generation
- structured-output/prompt-generator.test.ts: Edge cases for prompt generation

330 tests passing across 10 files in src/utils/

---

### Summary

The changes introduce potential flakiness into the test suite by using `setTimeout` for asynchronous cleanup and weaken a test by making it check for an implementation detail rather than behavior. Additionally, the commit message does not seem to align with the provided code changes.

### Issues Found

1.  **Non-deterministic test cleanup**:
    - **Files**: `src/components/Hooks/OnCIFailure.test.tsx` (lines 39-45), `src/components/Hooks/PostCommit.test.tsx` (lines 40-46)
    - **Issue**: The `cleanupTestContext` function uses `setTimeout` with a 10ms delay to close the database after the component root is disposed. This can lead to flaky tests, as there is no guarantee that asynchronous cleanup operations will complete within that fixed time.
    - **Issue**: The `try { ctx.db.close() } catch {}` block silently swallows any errors that might occur when closing the database connection. This can hide underlying problems.

2.  **Brittle test logic**:
    - **File**: `src/components/Hooks/OnCIFailure.test.tsx` (lines 517-522)
    - **Issue**: The test for `pollInterval` was changed from spying on `setInterval` to checking for a `poll-interval="5000"` attribute in the rendered XML. This tests an implementation detail (the prop being passed) rather than the actual behavior (the polling frequency). This makes the test more brittle; a refactoring of the underlying component that changes the prop name would break this test even if the functionality remains correct.

3.  **Inconsistent Commit Message**:
    - The commit message states, "Add comprehensive tests for src/utils/," and lists several new test files. However, the provided diff only contains modifications to two existing test files in `src/components/Hooks/`. This discrepancy is confusing and may indicate that the commit bundles unrelated changes or has an inaccurate description.

### Suggested Improvements

1.  **Make Cleanup Deterministic**:
    - Refactor the cleanup logic to be deterministic. If `ctx.root.dispose()` triggers asynchronous operations, it should return a `Promise` that resolves upon completion. The `cleanupTestContext` function should then `await` this promise before closing the database. This ensures cleanup is complete and avoids race conditions.

    **Example:**
    ```typescript
    // Assuming dispose() can be made async
    async function cleanupTestContext(ctx: TestContext): Promise<void> {
      await ctx.root.dispose() // Returns a promise that resolves when cleanup is done
      ctx.db.close() // Should not be in a silent try/catch
    }
    ```
    - Remove the `try/catch` block around `ctx.db.close()` or, at a minimum, log any errors that are caught.

2.  **Strengthen Polling Test**:
    - Revert the `pollInterval` test to verify the component's *behavior* rather than its implementation. If direct spying on `setInterval` is problematic, consider using fake timers (e.g., via `vi.useFakeTimers()` in Vitest or `jest.useFakeTimers()` in Jest) to control the passage of time and assert that the polling function is called as expected without using `setTimeout`.

3.  **Align Commit Message**:
    - The commit message should accurately reflect the changes. If these changes are intended to fix flaky tests, the message should state that, e.g., "Fix flaky tests by improving async cleanup in component hooks." Unrelated changes should be in separate commits.
