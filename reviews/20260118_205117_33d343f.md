# Code Review for Commit 33d343f

**Date:** 2026-01-18 20:51:17
**Commit Message:** Fix: Track worktree cleanup failures in database

---

### Summary

This commit bundles a wide variety of unrelated changes, and its commit message, "Fix: Track worktree cleanup failures in database," is inaccurate as it does not reflect the actual modifications. The changes themselves are generally positive improvements, such as adding tests, improving error handling, and refactoring for clarity. However, they are disorganized and should have been submitted as separate, atomic commits.

### Specific Issues Found

1.  **Critically Misleading Commit Message**: The commit message is entirely disconnected from the changes in the diff. The commit includes test implementations, documentation updates, error handling improvements, and refactoring across components, hooks, and utilities. None of these changes relate to tracking worktree cleanup failures in the database. This makes the repository history difficult to navigate and understand.

2.  **Mixing Unrelated Concerns**: The commit is a "kitchen sink" of different types of changes that should be separated. It bundles:
    *   **Tests**: New tests for the `<Subagent>` and `<Task>` components (`src/components/components.test.tsx`).
    *   **New Feature**: A new `extractText` utility function (`src/utils/extract-text.ts`).
    *   **Refactoring**: Using `extractText` (`src/components/Claude.tsx`, `src/components/Smithers.tsx`), and improving argument handling in a git utility (`src/utils/vcs/git.ts`).
    *   **Bug Fix / Hardening**: Adding `isClosed` checks to database interactions (`src/db/phases.ts`) and replacing swallowed exceptions with `console.debug` in multiple TUI hooks.
    *   **Documentation**: Updating component examples (`docs/components/task.mdx`) and adding new review files.

    Mixing these changes makes it difficult to review, revert, or cherry-pick individual updates.

3.  **Silent Error Suppression**: Across multiple TUI hooks (`usePollEvents.ts`, `useRenderFrames.ts`, etc.), previous commits were swallowing errors with empty `catch {}` blocks. While this commit laudably improves the situation by adding `console.debug`, it's worth noting that for a user-facing TUI, even debug-level logging might hide important failures from the user. Depending on the context, surfacing some of these errors to the UI might be a better long-term solution.

### Suggested Improvements

1.  **Revert and Re-commit**: The best course of action is to reset or revert this commit and split the changes into several smaller, atomic commits, each with a clear and accurate message. This will significantly improve the quality and maintainability of the project's history.

2.  **Adopt Atomic Commit Strategy**: Apply the following commit breakdown:
    *   `feat(utils): add extractText utility for React nodes`
    *   `refactor(components): use extractText for robust child text extraction`
    *   `test(components): implement tests for Subagent and Task components`
    *   `fix(db): prevent operations on closed database in phases module`
    *   `fix(tui): log polling and generation errors instead of swallowing them`
    *   `docs(components): update state management examples to use useQueryValue`
    *   `refactor(vcs): improve argument handling in addGitNotes utility`
    *   `docs(reviews): add code reviews for recent commits`
