# Code Review for Commit 10533bf

**Date:** 2026-01-18 01:18:41
**Commit Message:** fix: run tests from within src directory to avoid submodule tests

Bun's test runner was discovering tests in the reference/ submodule even
when specifying src/ as the target. Running tests from within the src
directory prevents this issue.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>

---

Review of changes in commit `10533bf`.

### Summary
The commit addresses a test discovery issue in Bun by changing the working directory for tests. It also adds two new React hooks (`usePrevious`, `useEffectOnValueChange`).

**Critical Issues Found**:
1.  **Broken Hook Logic (`useEffectOnValueChange`)**: The `useEffectOnValueChange` hook has a critical bug that causes effects to be **permanently cleaned up/destroyed** without being re-created in two common scenarios:
    *   **React Strict Mode**: Strict Mode mounts, unmounts, and remounts components.
        1.  Mount 1: Effect runs (Ref updated).
        2.  Unmount 1: Cleanup runs.
        3.  Mount 2: Ref matches current value -> **Effect skipped**.
        *   Result: The effect is cleaned up and never restarted.
    *   **Dependency Changes**: If `deps` change but `value` remains the same:
        1.  React triggers re-run (cleaning up the previous effect to prevent stale closures).
        2.  Hook checks `value` -> unchanged -> **Effect skipped**.
        *   Result: The effect is cleaned up and never restarted.
2.  **Test Working Directory**: Changing the test command to `cd src && bun test .` changes the `process.cwd()` for tests. Any tests relying on the project root (e.g., reading `package.json`, loading `.env` files, or using root-relative paths) will fail or misbehave.

### Specific Issues

**`package.json`**
*   **Lines 50-51**: `cd src && bun test ...`
    *   **Issue**: Changing CWD can break tests that assume the project root is the CWD.
    *   **Improvement**: Consider configuring `bunfig.toml` to ignore `reference/` or use `bun test src/` (if the original issue was misconfiguration). If `cd src` is required, verify no tests rely on root assets.

**`src/reconciler/hooks.ts`**
*   **Line 139 (`useEffectOnValueChange`)**: `if (... Object.is(lastValueRef.current, value)) { return; }`
    *   **Issue**: As detailed above, this early return prevents the effect from re-running after React has run the cleanup function (due to deps change or Strict Mode).
    *   **Improvement**: Standard `useEffect` already handles "only run when deps change" (using `Object.is` internally). If the goal is to *ignore* updates when `deps` change but `value` doesn't, you cannot safely do this if the effect has a cleanup function or uses those deps. If the effect has no cleanup and you strictly want to ignore deps changes, you must accept that the closure will be stale. The current implementation is unsafe.
*   **Lines 105, 124**: `@reference/vercel-ai-sdk/tsconfig.with-examples.json`
    *   **Issue**: The JSDoc `@reference` tags point to a `tsconfig.json` file, which is a configuration file and does not contain the usage examples shown in the comments. This looks like a copy-paste error.

### Suggested Improvements

1.  **Revert or Fix `useEffectOnValueChange`**:
    *   If the goal is standard effect behavior, just use `useEffect`.
    *   If the goal is to skip runs when `value` is stable despite `deps` changing, this is dangerous for effects with cleanups.
2.  **Verify Test Environment**: Ensure the CWD change in `package.json` doesn't break existing tests.
3.  **Fix Documentation**: Update the JSDoc references to point to the correct files or remove the confusing path.
