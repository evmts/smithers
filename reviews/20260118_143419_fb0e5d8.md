# Code Review for Commit fb0e5d8

**Date:** 2026-01-18 14:34:19
**Commit Message:** fix(db): align iteration key to ralphCount across DB layer

Schema and state.reset() seeded 'iteration' but code reads 'ralphCount'.
Also use JSON.parse instead of parseInt for state value parsing.

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>

---

### Summary

The commit's primary goal of aligning the database key from `iteration` to `ralphCount` is implemented correctly across the schema, tests, and application code. The switch from `parseInt` to `JSON.parse` is also a good improvement for consistency.

However, the commit includes two other significant and unrelated changes that are not mentioned in the commit message:
1.  A critical fix to the `useQuery` hook to ensure its cache is invalidated correctly.
2.  A major but flawed refactoring of `useQueryOne` and `useQueryValue` to add support for a context-based database connection.

This commit should not be merged as-is due to a bug introduced in the refactored hooks.

### Issues Found

1.  **BUG: Flawed Argument Parsing in `useQueryOne` and `useQueryValue`**
    - **Files**: `src/reactive-sqlite/hooks/useQueryOne.ts`, `src/reactive-sqlite/hooks/useQueryValue.ts`
    - **Description**: The new overloading logic to support an optional, context-based `db` instance is buggy. The code cannot reliably distinguish between the `options` object and an explicit `db` object when passed as arguments. For example, in a call like `useQueryOne(sql, params, explicitDb)`, the parser incorrectly treats the `explicitDb` object as the `options` object, and ignores the explicit database instance in favor of one from context. This will cause unexpected behavior and runtime errors.

2.  **Poor Commit Hygiene: Bundling Unrelated Changes**
    - **Description**: This commit bundles three distinct changes: a database key correction, a reactivity bug fix, and a hook API refactor. This makes the repository history difficult to read and understand. If the hook refactoring were to be reverted due to the bug, the other valid fixes would be reverted along with it.

3.  **Incomplete Commit Message**
    - **Description**: The commit message `fix(db): align iteration key to ralphCount across DB layer` is misleading as it only describes the simplest of the three changes included. It completely omits the reactivity fix and the hook refactoring, which are arguably more significant changes.

### Suggested Improvements

1.  **Revert or Fix the Bug**: The argument parsing logic in `useQueryOne` and `useQueryValue` must be fixed before this can be merged. A more robust pattern for handling overloads might be to accept a single options object (e.g., `useQueryOne({ sql, params, db })`) for the new signature instead of relying on positional arguments.

2.  **Split the Commit**: The changes should be separated into three atomic commits with clear, descriptive messages:
    - **Commit 1:** `fix(db): Align state key to ralphCount and use JSON parsing`
    - **Commit 2:** `fix(reactive-sqlite): Invalidate useQuery cache on subscription change`
    - **Commit 3:** `feat(reactive-sqlite): Add context support to useQueryOne and useQueryValue hooks` (This commit would contain the now-fixed version of the hook refactor).
