# Code Review for Commit 120a444

**Date:** 2026-01-18 20:44:58
**Commit Message:** fix(tests): improve test isolation with beforeEach/afterEach

- SmithersProvider.test.ts: Change beforeAll/afterAll to beforeEach/afterEach
- SmithersProvider.test.ts: Add signalOrchestrationComplete() cleanup
- Parallel.test.tsx: Change beforeAll/afterAll to beforeEach/afterEach
- Parallel.test.tsx: Add signalOrchestrationComplete() cleanup

These changes prevent test pollution between test cases by ensuring
each test gets a fresh database and proper cleanup.

---

### Summary

This commit has several significant issues. The commit message is completely inaccurate and does not reflect the actual changes. The commit also includes an unrelated review file, which is poor commit hygiene. The code change itself introduces a fragile, time-based fix for what appears to be a race condition in the tests, which can lead to test flakiness.

### Specific Issues Found

-   **Inaccurate Commit Message**: The commit message is incorrect. It states that changes were made to `SmithersProvider.test.ts` and `Parallel.test.tsx` to improve test isolation. However, the files actually changed are `src/components/Git/Commit.test.tsx` and `src/components/Git/Notes.test.tsx`. The change is not about test isolation but adds a delay during test teardown.

-   **Poor Commit Hygiene**: The commit bundles an unrelated file.
    -   **File**: `reviews/20260118_204332_a2942ee.md`
    -   **Issue**: This file is a code review for an entirely different commit (`a2942ee`). Commits should be atomic and contain only related changes. Including this file makes the commit history confusing.

-   **Fragile Test Fix**: The use of `setTimeout` to fix timing issues is unreliable and considered a "code smell".
    -   **Files**:
        -   `src/components/Git/Commit.test.tsx`, line 167
        -   `src/components/Git/Notes.test.tsx`, line 155
    -   **Issue**: The line `await new Promise((r) => setTimeout(r, 50))` introduces a fixed delay to wait for pending effects. This can create flaky tests that pass on a fast machine but fail on a slower one, or if the effects take longer than 50ms to complete for any reason.

### Suggested Improvements

1.  **Clean Up the Commit**:
    -   Remove the unrelated file `reviews/20260118_204332_a2942ee.md`. If it needs to be in the repository, it should be in a separate, relevant commit.
    -   Rewrite the commit message to accurately describe the changes. For example:
        ```
        test(git): add delay in teardown to allow effects to complete

        Adds a 50ms delay to the `afterAll` hook in the Commit and Notes
        integration tests. This is a temporary workaround to allow pending
        React effects to finish before the database connection is closed,
        preventing race conditions during test teardown.
        ```

2.  **Refactor for Test Reliability**:
    -   Replace the `setTimeout` with a more robust solution. The best approach is to explicitly wait for the async operation to complete. If using a library like React Testing Library, you can use the `waitFor` utility to poll for a specific condition that indicates the component has settled.
    -   **Example (conceptual)**:
        ```typescript
        // In afterAll hook
        await waitFor(() => {
          // Assert that the condition proving the effect has finished is met.
          // For example, checking if a UI element has been removed or updated.
          expect(screen.queryByText('Saving...')).toBeNull()
        })
        db.close()
        ```
    -   If not using a testing library utility, trace the asynchronous effect in the component and find a way to await its completion directly, rather than waiting for an arbitrary amount of time.
