# Code Review for Commit a2942ee

**Date:** 2026-01-18 20:43:32
**Commit Message:** test(quality): improve test assertions and edge cases

- jj.test.ts: Replace useless 'message handling' tests with actual parser tests
- parsers.test.ts: Replace weak '>= 0' assertions with exact value checks
- git.worktree.test.ts: Add edge cases (empty, whitespace, spaces in path, bare)
- capture.test.ts: Add specific expected types instead of 'toBeDefined'

---

### Summary

The commit introduces a mix of valuable improvements, significant bugs, and poor commit hygiene. While it correctly improves test teardown reliability and adds more robust error handling in a few places, it also introduces two critical bugs in the `useFirstMountState` hook and the `jjCommit` utility. Additionally, the commit message is inaccurate and it bundles unrelated review files, which obscures the purpose of the changes.

### Specific Issues Found

-   **Inaccurate Commit Message**: The commit message claims to "improve test assertions and edge cases" in files like `jj.test.ts`, `parsers.test.ts`, and `git.worktree.test.ts`. However, none of these files were modified. The actual changes relate to test cleanup, error handling, and React hook implementations.

-   **Bug: `useFirstMountState` Always Returns `false`**:
    -   **File**: `src/reconciler/hooks.ts`, Line 62
    -   **Issue**: The logic was changed from `return isFirst.current;` to `return false;`. This breaks the hook, as it will now *always* return `false`, defeating its purpose of identifying the initial render cycle of a component.
    -   **Before**:
        ```typescript
        return isFirst.current;
        ```
    -   **After**:
        ```typescript
        return false;
        ```

-   **Bug: `jjCommit` Uses Hardcoded and Incorrect Revision**:
    -   **File**: `src/utils/vcs/jj.ts`, Line 56
    -   **Issue**: The logic to get the `commitHash` now uses a hardcoded, nonsensical revision: `@src/monitor/haiku-summarizer.ts`. This appears to be a copy-paste error and will fail to resolve the correct commit hash. The revision should be relative, such as `@-`, which correctly refers to the parent of the working copy (i.e., the commit that was just created).
    -   **Incorrect Code**:
        ```typescript
        const commitHash = await Bun.$`jj log -r @src/monitor/haiku-summarizer.ts --no-graph -T commit_id`.text().then((s) => s.trim())
        ```

-   **Poor Commit Hygiene**:
    -   **Files**: `reviews/20260118_204118_eff575e.md`, `reviews/20260118_204159_95cf3fc.md`, `reviews/docs-broken-link-concepts-orchestration.md`
    -   **Issue**: This commit adds two new review files that belong to different commits and deletes another unrelated review. Commits should be atomic and group only related changes. Including these files clutters the history and makes the commit's intent unclear.

### Suggested Improvements

1.  **Fix Bugs**:
    -   Revert the change in `src/reconciler/hooks.ts` so that `useFirstMountState` returns `isFirst.current`.
    -   Correct the revision in `src/utils/vcs/jj.ts` to use a relative reference like `@-` to find the hash of the commit just created.

2.  **Clean Up Commit**:
    -   Remove the unrelated review files (`reviews/20260118_204118_eff575e.md`, `reviews/20260118_204159_95cf3fc.md`, `reviews/docs-broken-link-concepts-orchestration.md`) from this commit. They should be added in a separate, appropriate commit if necessary.

3.  **Update Commit Message**:
    -   Rewrite the commit message to accurately reflect the real changes. A better message would be:
        ```
        test(core): improve test teardown and hook reliability

        - refactor(JJ): Wrap component tests in try...finally to ensure spies are restored and roots are disposed.
        - fix(hooks): Add missing dependency to usePrevious to prevent running on every render.
        - fix(hooks): Ensure useEffectOnValueChange uses the latest effect callback.
        - chore(db): Add error handling when dropping tables during reset.
        ```
