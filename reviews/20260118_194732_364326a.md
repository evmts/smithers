# Code Review for Commit 364326a

**Date:** 2026-01-18 19:47:32
**Commit Message:** WIP: staged changes before cherry-pick

---

This commit has significant issues and should not be merged in its current state. While it aims to implement pending tests, it often does so in a way that reduces overall test coverage for critical functionality or uses flawed testing strategies.

The changes in `src/commands/db/memories-view.test.ts` are excellent and serve as a good model. However, the other three test files have major regressions.

### Specific Issues Found

#### 1. `src/commands/db/index.test.ts` - Core Logic No Longer Tested
- **Issue:** The original `test.todo`s for subcommand routing (e.g., `routes "state" to showState`), database lifecycle, and error handling have been removed, not implemented. The new tests almost exclusively check the output of the `showHelp()` function.
- **Impact:** The core responsibility of the `dbCommand`—routing to the correct subcommand function and managing the database connection—is no longer under test. This is a major regression in test coverage.

#### 2. `src/components/agents/claude-cli/executor.test.ts` - Process Execution Tests Removed
- **Issue:** The test file was refactored to remove all tests related to the actual spawning of the `claude` child process. The previous implementation, while complex, attempted to test stream handling, timeouts, and process exit codes. The new implementation explicitly skips this and only unit tests pure helper functions like `buildClaudeArgs`.
- **Impact:** The most critical and error-prone part of the executor—the interaction with the external CLI tool—is now completely untested. This leaves a significant gap in validating the component's reliability.

#### 3. `src/tui/hooks/useHumanRequests.test.ts` - Flawed Testing Strategy
- **Issue:** The new tests for the `useHumanRequests` hook are not actually testing the hook's behavior. Instead, they test small, isolated snippets of logic that are likely part of the hook's internal implementation. They do not use a testing library (like `@testing-library/react`) to render the hook and assert its state changes and side effects over time.
- **Impact:** The tests provide a false sense of security. The individual logic snippets might be correct, but the hook itself could be broken due to incorrect dependencies in `useEffect`, state not being updated properly, or other hook-specific issues. The tests do not validate that the hook functions correctly as a whole.

### Suggested Improvements
1.  **`src/commands/db/index.test.ts`**:
    -   Restore tests for subcommand routing. Mock the imported subcommand modules (e.g., `showState`, `showTransitions`) and verify that the main `dbCommand` function calls the correct one based on the input argument.
    -   Implement the tests for database lifecycle management, ensuring the database connection is created and properly closed, even on errors.

2.  **`src/components/agents/claude-cli/executor.test.ts`**:
    -   Re-introduce tests for the process execution logic in `executeClaudeCLIOnce`. While testing child processes is complex, it is essential. The previous approach of mocking the process and its streams can be reinstated, or an alternative strategy can be found, but this functionality should not be left untested.

3.  **`src/tui/hooks/useHumanRequests.test.ts`**:
    -   Rewrite the tests using a library like `@testing-library/react` and its `renderHook` utility.
    -   The tests should:
        -   Render the hook.
        -   Mock the global `db` dependency.
        -   Use `act()` and mock timers (`vi.useFakeTimers()`) to test the polling behavior and state updates over time.
        -   Call the returned functions (`approveRequest`, `rejectRequest`) and assert that the correct `db` methods are called and that the internal state is refreshed.
