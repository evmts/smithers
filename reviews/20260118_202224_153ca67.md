# Code Review for Commit 153ca67

**Date:** 2026-01-18 20:22:24
**Commit Message:** Add React reference library and enhance serialization bug report

- Added facebook/react as git submodule in reference/
- Enhanced bug report with React JSX internals context
- Added Bun JSX transform documentation
- Added debug commands and investigation checklist
- Linked to relevant React source files for understanding

---

This review covers two distinct changes in the commit: a new `StackedPRMerge` example and an enhanced bug report.

### Summary

The commit's update to the `numeric-props-serialization-bug.md` file is excellent, providing valuable debugging context, reference material, and a structured investigation plan that will greatly aid in resolving the issue.

However, the new `StackedPRMerge` example introduces several architectural and logical issues. The implementation suffers from unclear state management, a likely race condition in its data-fetching logic, and unsafe error handling that can hide bugs. While it's a useful example of a complex workflow, it needs significant refactoring to be robust and maintainable.

### Issues Found

#### 1. Unclear State Management and Potential Bugs

The main `StackedPRMerge` component relies on `useRef` to store and pass critical workflow state between phases. This is contrary to standard React patterns and introduces problems.

*   **File**: `examples/stacked-pr-merge/StackedPRMerge.tsx`
*   **Lines**: 29-33, 49-53, and throughout the component.

**Issue**: In React, updating a `ref` does not trigger a re-render. Child components receive the `ref`'s value at the time of their initial render and will not update when the ref is modified later. This means phases will operate on stale data. For example, `candidatesRef` is populated in an async `useMount` hook, but child components will receive its initial `[]` value.

Furthermore, there is a clear bug in how phase outputs are handled. The `onStatusComplete` callback from `WorktreeStatusPhase` receives `candidates`, but this data is immediately discarded instead of being used to update the `candidatesRef` for the next phase.

```tsx
// examples/stacked-pr-merge/StackedPRMerge.tsx:90-94
<WorktreeStatusPhase
  worktrees={worktreesRef.current}
  onStatusComplete={(candidates) => {
    // BUG: The `candidates` array produced by this phase is not stored.
    // The `candidatesRef` is never updated with this result.
    console.log(`[Merge] Found ${candidates.length} merge candidates`)
  }}
/>
```

#### 2. Race Condition and Confusing Data Flow

*   **File**: `examples/stacked-pr-merge/StackedPRMerge.tsx`
*   **Lines**: 44-60

**Issue**: The `useMount` hook fires an asynchronous function to fetch all worktree and PR data. The component renders before this operation completes, creating a race condition where all phases are initialized with empty data.

Additionally, the work done inside `useMount` (fetching status and calculating candidates) seems to be the responsibility of the `WorktreeStatusPhase` and `MergeOrderPhase` components themselves, making the overall data flow redundant and difficult to trace.

#### 3. Unsafe Error Handling

*   **File**: `examples/stacked-pr-merge/StackedPRMerge.tsx`
*   **Lines**: 168, 174, 180, etc.

**Issue**: The code uses empty `catch {}` blocks and the `.quiet()` method for shell commands (`gh`, `bun test`, etc.). This practice is dangerous as it completely swallows errors. If a command fails (e.g., `gh` is not installed, network error, a test fails), the script will silently continue with incorrect assumptions (e.g., that a PR doesn't exist or that tests passed), making debugging nearly impossible.

```tsx
// examples/stacked-pr-merge/StackedPRMerge.tsx:168-177
try {
  const prCheck = await Bun.$`gh pr list --head ${branch} --json number,title`.cwd(cwd).quiet()
  // ...
} catch {} // Any error from `gh` or JSON.parse() is silently ignored.
```

### Suggested Improvements

1.  **Refactor State Management**: Replace `useRef` with `useState` for managing workflow data like `worktrees` and `candidates`. This will ensure that components re-render correctly when data changes.
2.  **Centralize Phase Logic**: Remove the data-fetching logic from the `useMount` hook. Each `<Phase>` component should be responsible for its own logic. For instance, `WorktreeStatusPhase` should fetch the worktree status and then use a callback to update the central state in `StackedPRMerge`.
3.  **Implement Robust Error Handling**: Remove `.quiet()` from shell commands during development. In every `catch` block, at a minimum, log the error to the console (e.g., `console.error('Operation failed:', err)`). This will provide essential visibility for debugging.
4.  **Separate Concerns**: Extract the shell command and business logic (e.g., `fetchAllWorktreeStatus`, `calculateMergeCandidates`) into dedicated helper or service files. This will make the `StackedPRMerge` component cleaner, focused on orchestration, and easier to test.
