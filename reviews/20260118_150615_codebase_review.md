# Action Items (src)

- [critical] Fix step completion gating: `useQueryValue` stays on `SELECT 0` because `hasStartedRef`/`taskIdRef` flip after render with no re-render, so steps advance before child tasks finish. Make the query reactive to start (DB state or hook deps) and gate completion on real task counts. (`src/components/Step.tsx:206`)
- [critical] Scope and reset phase/step indices per execution + iteration: `currentPhaseIndex` and `stepIndex_${phaseId}` live in global `state` and `registerPhase`/`registerStep` de-dupe by name, so Ralph iterations and multi-execution reuse skip phases/steps. Include executionId+ralphCount in keys and reset at iteration start. (`src/components/PhaseRegistry.tsx:58`, `src/components/Step.tsx:49`)
- [major] Reset per-run state (`ralphCount`, phase/step indices, stop/rebase flags) on execution start or move to an execution-scoped table; current `INSERT OR IGNORE` preserves stale values across runs. (`src/components/SmithersProvider.tsx:298`, `src/db/state.ts:40`)
- [major] Remove non-TUI `useState` from orchestration core to keep DB as SSOT and survive restarts: `src/hooks/useHuman.ts:1`, `src/reactive-sqlite/hooks/useMutation.ts:5`, `src/reactive-sqlite/hooks/shared.ts:5`.
- [major] Replace module-level orchestration globals (`globalSmithersContext`, `_orchestrationResolve/_orchestrationReject`) with per-root context if parallel roots or concurrent executions are supported; current singleton will clobber concurrent runs. (`src/components/SmithersProvider.tsx:18`)
- [minor] Drop `shell: true` and properly escape args in `src/commands/run.ts:57` and `src/commands/monitor.ts:65` to avoid path-with-spaces breakage and shell injection risk.
- [minor] Use separate `TextDecoder` instances per stream to avoid decode state bleed. (`src/components/agents/claude-cli/executor.ts:57`, `src/components/agents/SmithersCLI.ts:262`)
- [minor] Resolve stale core export TODO (restore/replace `executePlan` or remove reference). (`src/core/index.ts:5`)
