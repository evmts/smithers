name: Generate VHS Demos

on:
  push:
    branches: [main]
    paths:
      - 'demos/**/*.tape'
      - 'src/tui/**/*.tsx'
      - 'src/tui/**/*.ts'
  pull_request:
    paths:
      - 'demos/**/*.tape'
      - 'src/tui/**/*.tsx'
      - 'src/tui/**/*.ts'

jobs:
  generate-demos:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build Smithers
        run: bun run build

      - name: Make CLI executable
        run: |
          chmod +x src/cli/index.ts
          # Create symlink for smithers command
          mkdir -p $HOME/.local/bin
          ln -sf $PWD/src/cli/index.ts $HOME/.local/bin/smithers
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify Smithers CLI
        run: |
          which smithers || echo "smithers not in PATH yet"
          smithers --version || echo "smithers command failed"

      - name: Generate VHS recordings
        uses: charmbracelet/vhs-action@v2
        with:
          path: 'demos'
        env:
          # Use mock mode to avoid API calls
          SMITHERS_MOCK: 'true'

      - name: Commit generated GIFs (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: regenerate VHS demo recordings'
          file_pattern: 'demos/*.gif demos/*.mp4 demos/*.webm'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Upload demo artifacts (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: demo-recordings
          path: |
            demos/*.gif
            demos/*.mp4
            demos/*.webm
          retention-days: 30
