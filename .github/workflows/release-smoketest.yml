name: Release Smoketest

on:
  workflow_run:
    workflows: ["Publish to npm and GitHub Release"]
    types: [completed]

jobs:
  smoketest:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Extract release info
        id: release
        run: |
          # Get the tag that triggered the publish workflow
          TAG=$(git describe --tags --abbrev=0)
          VERSION=${TAG#v}
          PREV_TAG=$(git describe --tags --abbrev=0 ${TAG}^ 2>/dev/null || echo "")
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Wait for npm availability
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          echo "Waiting for smithers-orchestrator@${VERSION} to be available on npm..."
          
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if npm view smithers-orchestrator@${VERSION} version 2>/dev/null; then
              echo "Package available!"
              exit 0
            fi
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting 10s..."
            sleep 10
          done
          
          echo "Package not available after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Gather git history with notes
        id: history
        run: |
          PREV_TAG="${{ steps.release.outputs.prev_tag }}"
          TAG="${{ steps.release.outputs.tag }}"

          # Build JSON array of commits with proper escaping
          COMMITS=()
          if [ -n "$PREV_TAG" ]; then
            RANGE="$PREV_TAG..$TAG"
          else
            RANGE="-20"
          fi

          while IFS= read -r line; do
            HASH=$(echo "$line" | cut -d'|' -f1)
            SUBJECT=$(echo "$line" | cut -d'|' -f2 | jq -Rs '.' | sed 's/^"\(.*\)"$/\1/')
            COMMITS+=("{\"hash\":\"$HASH\",\"subject\":\"$SUBJECT\"}")
          done < <(git log --pretty=format:'%H|%s' $RANGE)

          # Join array into JSON
          HISTORY="[$(IFS=,; echo "${COMMITS[*]}")]"

          echo "history<<EOF" >> $GITHUB_OUTPUT
          echo "$HISTORY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run smoketest orchestrator
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SMITHERS_VERSION: ${{ steps.release.outputs.version }}
          GIT_HISTORY: ${{ steps.history.outputs.history }}
        run: bun scripts/release-smoketest.tsx

      - name: Upload smoketest results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoketest-results
          path: |
            .smithers/
            smoketest-project/
