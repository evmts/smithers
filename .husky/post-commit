#!/bin/sh

# Get the commit hash and message
COMMIT_HASH=$(git rev-parse --short HEAD)
COMMIT_MSG=$(git log -1 --pretty=%B)

# Get the diff of the last commit
DIFF=$(git diff HEAD~1 HEAD 2>/dev/null)

# Skip if no diff (e.g., initial commit)
if [ -z "$DIFF" ]; then
  exit 0
fi

# Create a temporary file for the review
TEMP_REVIEW=$(mktemp)

# Run Gemini CLI to review the code changes
echo "Running Gemini code review..."
npx --yes https://github.com/google-gemini/gemini-cli --yolo "Review the following code changes from commit $COMMIT_HASH.

If the changes look good with no issues, respond with just 'LGTM' and nothing else.

If there are suggestions for improvements, security concerns, bugs, or other issues, provide a detailed review in markdown format with:
- A brief summary
- Specific issues found (with file paths and line numbers if applicable)
- Suggested improvements

Commit message: $COMMIT_MSG

Changes:
$DIFF" > "$TEMP_REVIEW" 2>/dev/null

# Check if review was generated
if [ ! -s "$TEMP_REVIEW" ]; then
  rm -f "$TEMP_REVIEW"
  exit 0
fi

# Read the review content
REVIEW_CONTENT=$(cat "$TEMP_REVIEW")

# Check if it's just LGTM (case insensitive, allowing for whitespace)
NORMALIZED=$(echo "$REVIEW_CONTENT" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')

if [ "$NORMALIZED" = "lgtm" ] || [ "$NORMALIZED" = "lgtm!" ] || [ "$NORMALIZED" = "lgtm." ]; then
  echo "Review: LGTM - no issues found"
  rm -f "$TEMP_REVIEW"
  exit 0
fi

# Has actual suggestions - save the review
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REVIEW_FILE="reviews/${TIMESTAMP}_${COMMIT_HASH}.md"

cat > "$REVIEW_FILE" << EOF
# Code Review for Commit $COMMIT_HASH

**Date:** $(date '+%Y-%m-%d %H:%M:%S')
**Commit Message:** $COMMIT_MSG

---

$REVIEW_CONTENT
EOF

echo "Code review saved to $REVIEW_FILE"
rm -f "$TEMP_REVIEW"
