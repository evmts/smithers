#!/bin/sh

# Ensure reviews directory exists
mkdir -p reviews

# Get the commit hash and message
COMMIT_HASH=$(git rev-parse --short HEAD)
COMMIT_MSG=$(git log -1 --pretty=%B)

# Get the diff of the last commit (handle initial commit)
if git rev-parse HEAD~1 >/dev/null 2>&1; then
  DIFF=$(git diff HEAD~1 HEAD)
else
  # Initial commit - diff against empty tree
  DIFF=$(git diff 4b825dc642cb6eb9a060e54bf8d69288fbee4904 HEAD)
fi

# Skip if no diff
if [ -z "$DIFF" ]; then
  exit 0
fi

# Create temporary files for the prompt and review
TEMP_PROMPT=$(mktemp)
TEMP_REVIEW=$(mktemp)
TEMP_STDERR=$(mktemp)

# Write prompt to file to avoid shell escaping issues
cat > "$TEMP_PROMPT" << 'PROMPT_END'
Review the following code changes.

If the changes look good with no issues, respond with just 'LGTM' and nothing else.

If there are suggestions for improvements, security concerns, bugs, or other issues, provide a detailed review in markdown format with:
- A brief summary
- Specific issues found (with file paths and line numbers if applicable)
- Suggested improvements

PROMPT_END

printf "Commit: %s\n" "$COMMIT_HASH" >> "$TEMP_PROMPT"
printf "Commit message: %s\n" "$COMMIT_MSG" >> "$TEMP_PROMPT"
printf "\nChanges:\n" >> "$TEMP_PROMPT"
printf "%s\n" "$DIFF" >> "$TEMP_PROMPT"

# Run Gemini CLI to review the code changes
# Stderr goes to separate file to avoid polluting the review
echo "Running Gemini code review..."
cat "$TEMP_PROMPT" | npx --yes https://github.com/google-gemini/gemini-cli --yolo > "$TEMP_REVIEW" 2>"$TEMP_STDERR"

# Check exit status
EXIT_CODE=$?
if [ $EXIT_CODE -ne 0 ]; then
  echo "Gemini CLI failed (exit code $EXIT_CODE):"
  cat "$TEMP_STDERR"
  rm -f "$TEMP_PROMPT" "$TEMP_REVIEW" "$TEMP_STDERR"
  exit 0
fi

# Check if review was generated
if [ ! -s "$TEMP_REVIEW" ]; then
  echo "No review generated"
  rm -f "$TEMP_PROMPT" "$TEMP_REVIEW" "$TEMP_STDERR"
  exit 0
fi

# Read the review content
REVIEW_CONTENT=$(cat "$TEMP_REVIEW")

# Check if it's just LGTM (case insensitive, allowing for whitespace and punctuation)
NORMALIZED=$(printf "%s" "$REVIEW_CONTENT" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:][:punct:]')

if [ "$NORMALIZED" = "lgtm" ]; then
  echo "Review: LGTM - no issues found"
  rm -f "$TEMP_PROMPT" "$TEMP_REVIEW" "$TEMP_STDERR"
  exit 0
fi

# Has actual suggestions - save the review
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REVIEW_FILE="reviews/${TIMESTAMP}_${COMMIT_HASH}.md"

cat > "$REVIEW_FILE" << EOF
# Code Review for Commit $COMMIT_HASH

**Date:** $(date '+%Y-%m-%d %H:%M:%S')
**Commit Message:** $COMMIT_MSG

---

$REVIEW_CONTENT
EOF

echo "Code review saved to $REVIEW_FILE"
rm -f "$TEMP_PROMPT" "$TEMP_REVIEW" "$TEMP_STDERR"
